# راهنمای سیستم بروزرسانی لینک Subscription

## 📋 خلاصه

سیستم بروزرسانی لینک subscription به کاربران و ادمین‌ها امکان بروزرسانی لینک‌های subscription را از پنل اصلی X-UI می‌دهد. این سیستم تضمین می‌کند که لینک‌ها همیشه آخرین تنظیمات پنل را داشته باشند.

## 🔧 ویژگی‌ها

### برای کاربران:
- **بروزرسانی لینک شخصی**: هر کاربر می‌تواند لینک subscription خود را بروزرسانی کند
- **نمایش وضعیت**: نمایش پیام‌های موفقیت یا خطا
- **دسترسی آسان**: از طریق منوی "سرویس‌های من"

### برای ادمین‌ها:
- **بروزرسانی همه لینک‌ها**: بروزرسانی یکجا همه لینک‌های فعال
- **نمایش آمار**: نمایش تعداد لینک‌های موفق و ناموفق
- **کنترل کامل**: از طریق منوی ادمین

## 🚀 نحوه استفاده

### برای کاربران:

1. **ورود به منوی سرویس‌ها**:
   ```
   منوی اصلی → سرویس‌های من
   ```

2. **انتخاب سرویس**:
   ```
   کلیک روی سرویس مورد نظر
   ```

3. **بروزرسانی لینک**:
   ```
   کلیک روی "🔄 بروزرسانی لینک"
   ```

4. **انتظار برای نتیجه**:
   ```
   سیستم پیام موفقیت یا خطا نمایش می‌دهد
   ```

### برای ادمین‌ها:

1. **ورود به منوی ادمین**:
   ```
   منوی اصلی → منوی ادمین
   ```

2. **انتخاب بروزرسانی**:
   ```
   کلیک روی "🔄 بروزرسانی همه لینک‌ها"
   ```

3. **انتظار برای نتیجه**:
   ```
   سیستم آمار کامل نمایش می‌دهد
   ```

## 🔗 API Endpoints

### بروزرسانی کانفیگ‌ها:
```
POST /admin/update_configs/{purchase_id}
```

**Headers:**
```
Authorization: Bearer {ADMIN_API_KEY}
```

**Response:**
- `200`: بروزرسانی موفق
- `401`: خطای احراز هویت
- `404`: خرید یافت نشد
- `500`: خطای سرور

### دریافت لینک Subscription:
```
GET /sub/{sub_id}
```

**Response:**
- `200`: لینک subscription (Base64 encoded)
- `404`: لینک یافت نشد یا غیرفعال

## ⚙️ تنظیمات

### متغیرهای محیطی:

```bash
# دامنه webhook
WEBHOOK_DOMAIN=your-domain.com

# کلید API ادمین
ADMIN_API_KEY=your-secret-key
```

### تنظیمات دیتابیس:

```sql
-- جدول purchases باید فیلدهای زیر را داشته باشد:
-- sub_id: شناسه یکتا برای subscription
-- single_configs_json: کانفیگ‌های ذخیره شده
-- updated_at: زمان آخرین بروزرسانی
```

## 🔄 فرآیند بروزرسانی

1. **درخواست بروزرسانی**: کاربر یا ادمین درخواست بروزرسانی می‌دهد

2. **ارتباط با پنل**: سیستم به پنل X-UI متصل می‌شود

3. **دریافت دیتا**: کانفیگ‌های جدید از پنل دریافت می‌شود

4. **پردازش محتوا**: محتوا تشخیص و پردازش می‌شود (Base64, JSON, V2Ray)

5. **ذخیره در دیتابیس**: کانفیگ‌های جدید در دیتابیس ذخیره می‌شود

6. **بازگشت نتیجه**: پیام موفقیت یا خطا به کاربر نمایش داده می‌شود

## 🛡️ امنیت

- **احراز هویت**: همه درخواست‌های ادمین نیاز به API key دارند
- **اعتبارسنجی**: بررسی وجود خرید و سرور قبل از بروزرسانی
- **مدیریت خطا**: مدیریت کامل خطاها و نمایش پیام‌های مناسب

## 📊 مانیتورینگ

### لاگ‌های مهم:
```
- بروزرسانی موفق: "Successfully updated cached configs for purchase {id}"
- خطای پنل: "Error fetching subscription data from panel"
- خطای دیتابیس: "Error updating purchase configs for {id}"
```

### آمار قابل ردیابی:
- تعداد بروزرسانی‌های موفق
- تعداد بروزرسانی‌های ناموفق
- زمان متوسط بروزرسانی
- خطاهای رایج

## 🔧 عیب‌یابی

### مشکلات رایج:

1. **خطای 401 (Unauthorized)**:
   - بررسی صحت ADMIN_API_KEY
   - اطمینان از وجود header Authorization

2. **خطای 404 (Not Found)**:
   - بررسی وجود purchase_id در دیتابیس
   - بررسی فعال بودن subscription

3. **خطای 500 (Server Error)**:
   - بررسی اتصال به پنل X-UI
   - بررسی تنظیمات سرور

### تست سیستم:

```bash
# اجرای تست‌ها
python test_subscription_refresh.py

# بررسی لاگ‌ها
tail -f /var/log/alamorvpn_bot.log
```

## 📝 نکات مهم

1. **عملکرد**: سیستم ابتدا از پنل اصلی دیتا دریافت می‌کند، در صورت خطا از کش استفاده می‌کند

2. **سرعت**: بروزرسانی معمولاً 5-10 ثانیه طول می‌کشد

3. **محدودیت**: هر کاربر فقط می‌تواند لینک‌های خود را بروزرسانی کند

4. **پشتیبانی**: سیستم از همه نوع محتوای subscription پشتیبانی می‌کند

5. **مقیاس‌پذیری**: امکان بروزرسانی همزمان چندین لینک وجود دارد

## 🎯 مزایا

- **به‌روزرسانی خودکار**: لینک‌ها همیشه آخرین تنظیمات را دارند
- **قابلیت اطمینان**: سیستم fallback برای مواقع خطا
- **کاربرپسند**: رابط کاربری ساده و قابل فهم
- **امن**: احراز هویت و اعتبارسنجی کامل
- **مقیاس‌پذیر**: پشتیبانی از تعداد زیاد لینک
