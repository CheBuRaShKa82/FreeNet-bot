# 🚀 راهنمای سیستم Subscription جدید

## 📋 **خلاصه تغییرات**

سیستم subscription ربات AlamorVPN به‌طور کامل بازطراحی شده است تا مشکلات قبلی را حل کند و قابلیت‌های جدیدی ارائه دهد.

## 🔧 **مشکلات حل شده**

### ❌ **مشکلات قبلی:**
1. **بروزرسانی نشدن لینک‌ها:** وقتی ادمین پورت یا تنظیمات اینباند را تغییر می‌داد، کاربران تغییرات را نمی‌دیدند
2. **تک سروری:** خریدهای پروفایل فقط از یک سرور دیتا دریافت می‌کردند
3. **عدم انعطاف:** سیستم قابلیت توزیع بار نداشت

### ✅ **راه‌حل‌های جدید:**
1. **داینامیک کامل:** لینک‌ها همیشه از پنل اصلی دیتا دریافت می‌کنند
2. **چند سروری:** خریدهای پروفایل از تمام سرورهای مرتبط دیتا جمع‌آوری می‌کنند
3. **فیلتر هوشمند:** فقط کانفیگ‌های مربوط به اینباندهای پروفایل برگردانده می‌شوند

## 🏗️ **معماری جدید**

### **برای خرید پروفایل:**
```python
# سیستم جدید
def get_profile_subscription_data(purchase):
    # 1. دریافت تمام اینباندهای پروفایل از تمام سرورها
    profile_inbounds = db_manager.get_inbounds_for_profile(profile_id, with_server_info=True)
    
    # 2. گروه‌بندی بر اساس سرور
    inbounds_by_server = group_inbounds_by_server(profile_inbounds)
    
    # 3. دریافت دیتا از هر سرور
    all_configs = []
    for server_id, server_inbounds in inbounds_by_server.items():
        server_subscription_data = get_panel_subscription_data(server_info, sub_id)
        processed_configs = process_server_configs(server_subscription_data, server_inbounds)
        all_configs.extend(processed_configs)
    
    # 4. ترکیب و برگرداندن
    return "\n".join(all_configs)
```

### **برای خرید عادی:**
```python
# سیستم جدید
def get_normal_subscription_data(purchase):
    # فقط از سرور انتخاب شده دیتا دریافت می‌کند
    server = db_manager.get_server_by_id(purchase['server_id'])
    return get_panel_subscription_data(server, purchase['sub_id'])
```

## 🎯 **ویژگی‌های کلیدی**

### **1. جمع‌آوری دیتا از چندین سرور**
- خریدهای پروفایل از تمام سرورهای مرتبط دیتا دریافت می‌کنند
- امکان توزیع بار روی سرورهای مختلف
- افزایش پایداری و سرعت

### **2. فیلتر هوشمند کانفیگ‌ها**
```python
def is_config_for_profile_inbounds(config, server_inbounds):
    # بررسی بر اساس remark
    config_remark = extract_config_remark(config)
    
    for inbound_info in server_inbounds:
        inbound_remark = inbound_info.get('remark', '')
        if inbound_remark and config_remark.lower() in inbound_remark.lower():
            return True
        
        # بررسی بر اساس inbound_id
        inbound_id = inbound_info.get('inbound_id')
        if inbound_id and str(inbound_id) in config:
            return True
    
    return False
```

### **3. استخراج خودکار remark**
- **VMess:** استخراج از فیلد `ps` در JSON
- **VLESS/Trojan:** استخراج از بخش بعد از `#`
- **پشتیبانی از فرمت‌های مختلف**

### **4. بروزرسانی خودکار**
- تغییرات ادمین بلافاصله اعمال می‌شوند
- نیازی به restart ربات نیست
- سیستم cache هوشمند

## 🎮 **نحوه استفاده**

### **برای ادمین:**

#### **1. بروزرسانی همه لینک‌ها:**
```
منوی ادمین → 🔄 بروزرسانی همه لینک‌ها
```

#### **2. مشاهده وضعیت سیستم:**
```
منوی ادمین → 📊 وضعیت سیستم Subscription
```

#### **3. بررسی لینک‌ها:**
```
منوی ادمین → 🔧 بررسی لینک‌های Subscription
```

### **برای کاربر:**

#### **1. بروزرسانی ترافیک:**
```
سرویس‌های من → انتخاب سرویس → 🔄 بروزرسانی ترافیک
```

#### **2. بروزرسانی لینک ساب:**
```
سرویس‌های من → انتخاب سرویس → 🔄 بروزرسانی لینک
```

## 📊 **نمایش نتایج**

### **بروزرسانی همه لینک‌ها:**
```
🔄 بروزرسانی لینک‌های Subscription

📊 نتایج کلی:
• ✅ موفق: 15 لینک
• ❌ ناموفق: 2 لینک
• 📈 کل: 17 لینک

📋 جزئیات خریدها:
• 🎯 خریدهای پروفایل: 8
• 🔧 خریدهای عادی: 9

🎉 سیستم جدید فعال شد!
✅ لینک‌های پروفایل از تمام سرورهای مرتبط بروزرسانی شدند.
✅ لینک‌های عادی از سرورهای مربوطه بروزرسانی شدند.

🔗 ویژگی جدید:
• خریدهای پروفایل حالا از تمام سرورهای پروفایل دیتا جمع‌آوری می‌کنند
• تغییرات ادمین در پورت‌ها و تنظیمات بلافاصله اعمال می‌شوند
• سیستم فیلتر هوشمند کانفیگ‌ها فعال است
```

### **وضعیت سیستم:**
```
📊 وضعیت سیستم Subscription

🔗 تنظیمات:
• Webhook Domain: example.com
• Admin API Key: تنظیم شده

📈 آمار خریدها:
• کل خریدهای فعال: 17
• خریدهای پروفایل: 8
• خریدهای عادی: 9

🎯 پروفایل‌ها:
• پروفایل‌های فعال: 3
  - پروفایل برنزی: 5 اینباند
  - پروفایل نقره‌ای: 3 اینباند
  - پروفایل طلایی: 4 اینباند

🚀 ویژگی‌های جدید:
✅ جمع‌آوری دیتا از تمام سرورهای پروفایل
✅ بروزرسانی خودکار تغییرات ادمین
✅ فیلتر هوشمند کانفیگ‌ها
✅ سیستم داینامیک subscription
```

## 🔧 **تنظیمات مورد نیاز**

### **متغیرهای محیطی:**
```bash
# در فایل .env
WEBHOOK_DOMAIN=your-domain.com
ADMIN_API_KEY=your-secret-api-key
```

### **ساختار دیتابیس:**
```sql
-- جدول profile_inbounds برای ارتباط پروفایل‌ها با سرورها
CREATE TABLE profile_inbounds (
    id SERIAL PRIMARY KEY,
    profile_id INTEGER REFERENCES profiles(id),
    server_id INTEGER REFERENCES servers(id),
    inbound_id INTEGER NOT NULL,
    config_params JSONB,
    raw_template TEXT,
    UNIQUE (profile_id, server_id, inbound_id)
);
```

## 🚨 **نکات مهم**

### **1. سازگاری:**
- سیستم جدید با خریدهای قدیمی سازگار است
- هیچ تغییری در عملکرد خریدهای عادی ایجاد نشده
- خریدهای پروفایل به‌طور خودکار از سیستم جدید استفاده می‌کنند

### **2. عملکرد:**
- بروزرسانی ممکن است کمی زمان‌بر باشد (بسته به تعداد سرورها)
- سیستم cache برای بهبود سرعت استفاده می‌شود
- در صورت عدم دسترسی به پنل، از دیتای cache استفاده می‌شود

### **3. امنیت:**
- تمام درخواست‌ها با API Key محافظت می‌شوند
- لاگ کامل تمام عملیات
- مدیریت خطاهای مختلف

## 🎉 **نتیجه‌گیری**

سیستم جدید subscription مشکلات اصلی را حل کرده و قابلیت‌های زیر را ارائه می‌دهد:

✅ **داینامیک کامل:** لینک‌ها همیشه به‌روز هستند  
✅ **چند سروری:** پشتیبانی از چندین سرور برای پروفایل‌ها  
✅ **فیلتر هوشمند:** فقط کانفیگ‌های مربوطه برگردانده می‌شوند  
✅ **بروزرسانی خودکار:** تغییرات ادمین بلافاصله اعمال می‌شوند  
✅ **سازگاری:** با سیستم‌های قدیمی سازگار است  

این سیستم باعث بهبود تجربه کاربری و مدیریت آسان‌تر سرویس‌ها می‌شود.
