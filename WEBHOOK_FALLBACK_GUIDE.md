# üîÑ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Å–∏—Å—Ç–µ–º–µ Fallback –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Subscription

## üéØ **–†–µ—à—ë–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**

–†–∞–Ω–µ–µ, –∫–æ–≥–¥–∞ –Ω–∞–∂–∏–º–∞–ª–∞—Å—å –∫–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å—Å—ã–ª–∫–∏", –µ—Å–ª–∏ –ø–∞–Ω–µ–ª–∏ X-UI –±—ã–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, —Å–∏—Å—Ç–µ–º–∞ –≤—ã–¥–∞–≤–∞–ª–∞ –æ—à–∏–±–∫—É HTTP 500.

## ‚úÖ **–ù–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**

### **1. –£–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ Fallback:**
- **–°–Ω–∞—á–∞–ª–∞:** –ü—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞–Ω–µ–ª–µ–π X-UI
- **–ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ–≥–¥–∞ —É—Å–ø–µ—à–Ω–æ (–µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö)

### **2. –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:**
- –û—à–∏–±–∫–∏ HTTP 500 –ø—Ä–µ–≤—Ä–∞—â–µ–Ω—ã –≤ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- –°–∏—Å—Ç–µ–º–∞ –∏–º–µ–µ—Ç graceful degradation
- –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π

## üîß **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

### **–í `webhook_server.py`:**

#### **1. –§—É–Ω–∫—Ü–∏—è `update_cached_configs_from_panel`:**
```python
# –ï—Å–ª–∏ –Ω–µ —Å–º–æ–≥–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞–Ω–µ–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
if not subscription_data:
    logger.warning(f"Could not fetch subscription data from panel for purchase {purchase_id}, using cached data")
    cached_configs = purchase.get('single_configs_json')
    if cached_configs:
        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```

#### **2. –§—É–Ω–∫—Ü–∏—è `get_profile_subscription_data`:**
```python
if not all_configs:
    logger.warning(f"No configs collected from any server for profile {profile_id}, trying fallback")
    # Fallback: –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    cached_configs = purchase.get('single_configs_json')
```

## üöÄ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã:**

### **1. –í—ã—Å–æ–∫–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
- –î–∞–∂–µ –µ—Å–ª–∏ –ø–∞–Ω–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è, —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –°—Å—ã–ª–∫–∏ subscription –±–æ—Ç–∞ –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞—é—Ç
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–º–µ–Ω–∞ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### **2. –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –°–Ω–∏–∂–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ HTTP 500
- –ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
- –õ—É—á—à–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

### **3. –õ–µ–≥–∫–æ–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π:**
- –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ –ª–æ–≥–∏
- –õ–µ–≥–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º
- –ü–æ–¥—Ä–æ–±–Ω—ã–µ –æ—Ç—á–µ—Ç—ã

## üìã **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

### **–î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫:**
1. –ü—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞–Ω–µ–ª–∏ X-UI
2. –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
3. –ï—Å–ª–∏ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### **–î–ª—è –ø–æ–∫—É–ø–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π:**
1. –ü—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø—Ä–æ—Ñ–∏–ª—è
2. –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
3. –ï—Å–ª–∏ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

## üéâ **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

**–¢–µ–ø–µ—Ä—å –∫–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å—Å—ã–ª–∫–∏" –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!**

- ‚úÖ –ü–∞–Ω–µ–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã ‚Üí –ü–æ–ª—É—á–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ü–∞–Ω–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è ‚Üí –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –°–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã ‚Üí –°–∏—Å—Ç–µ–º–∞ –∏–º–µ–µ—Ç graceful degradation
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–º–µ–Ω–∞ ‚Üí –ù–µ –≤–ª–∏—è—é—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

## üîç **–ù–æ–≤—ã–µ –ª–æ–≥–∏:**

### **–£—Å–ø–µ—Ö –∏–∑ –ø–∞–Ω–µ–ª–∏:**
```
INFO: Successfully fetched subscription data for purchase 1, length: 2048
```

### **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
```
WARNING: Could not fetch subscription data from panel for purchase 1, using cached data
INFO: Using cached configs for purchase 1: 5 configs
```

### **–û—à–∏–±–∫–∞ –≤ –ø–∞—Ä—Å–∏–Ω–≥–µ:**
```
ERROR: Error parsing cached configs for purchase 1: Invalid JSON format
```

---
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** $(date)
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é